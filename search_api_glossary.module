<?php
/**
 * @file
 * Search api glossary module file.
 */

 // TODO: port to d8
 /**
  * Implements hook_entity_property_info().
  *
  * @see entity_entity_property_info()
  */
/*
 function search_api_glossary_entity_property_info() {
   $info = array();

   // Add meta-data about the basic node properties.
   $properties = &$info['node']['properties'];

   $properties['title_az_glossary'] = array(
     'label' => t("Title A-Z Glossary"),
     'type' => 'text',
     'description' => t("The A-Z Glossary from title of the node."),
     'getter callback' => 'search_api_glossary_title_getter_callback',
     'schema field' => 'az_title',
     'sanitized' => TRUE,
   );

   return $info;
 }
*/


/**
 * Add search_api_glossary settings to Search API Index configuration.
 *
 * Implements hook_form_FORM_ID_alter().
 */
//function search_api_glossary_form_search_api_admin_index_fields_alter(&$form, \Drupal\Core\Form\FormStateInterface $form_state, $form_id) {
function search_api_glossary_form_search_api_index_fields_alter(&$form, \Drupal\Core\Form\FormStateInterface $form_state, $form_id) {
  // set the defaults
/*
  $form['fields']['title_az_glossary']['type']['#default_value'] = 'string';
  $form['fields']['title_az_glossary']['type']['#disabled'] = TRUE;

  $form['fields']['title_az_glossary']['indexed']['#default_value'] = TRUE;
  $form['fields']['title_az_glossary']['indexed']['#disabled'] = TRUE;*/

  $entity = $form_state->getFormObject()->getEntity();
  $field_instances = $entity->get('fieldInstances');
  $allowed_fields = array('none' => t('none'));
  $enabled_fields = array('none' => t('none'));

  //Allow only integers, text or strings to be used for glossary
  foreach ($field_instances as $field_instance) {
    //Set the allowed fields
    $field_name = $field_instances->get('fieldIdentifier');
    $field_label = $field_instances->get('label');
    $field_type = $field_instances->get('type');

    if (substr($field_name, -3) != '_az') {
      if ($field_type == 'integer' || $field_type == 'text' || $field_type == 'string') {
        $allowed_fields[$field_name] = $field_label;
      }
    }
  }

  ksm($allowed_fields);
}
